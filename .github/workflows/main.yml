name: macOS noVNC Debug (FIXED)

on:
  workflow_dispatch:

jobs:
  novnc:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install VNC + websockify
        run: |
          brew update
          brew install tiger-vnc websockify

      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git $HOME/noVNC
          git clone https://github.com/novnc/websockify.git $HOME/noVNC/utils/websockify

      - name: Configure VNC
        run: |
          mkdir -p ~/.vnc
          echo "debug123" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          open -a Finder
          EOF

          chmod +x ~/.vnc/xstartup

      - name: Start VNC server
        run: |
          vncserver -localhost no :1

      - name: Start noVNC
        run: |
          $HOME/noVNC/utils/novnc_proxy \
            --vnc localhost:5901 \
            --listen 6080
